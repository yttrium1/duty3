<script>
    const liffId = '2006692584-PX48YKoN';
    const serverUrl = 'https://688eca87-9817-447e-ac73-bfe4df7d0c85-00-2es7no9v6pfu4.sisko.replit.dev/api/get-status';

    async function initializeLiff() {
        try {
            await liff.init({ liffId });
            console.log('LIFF初期化成功');

            if (!liff.isLoggedIn()) {
                liff.login();
            }
        } catch (err) {
            console.error('LIFF初期化エラー:', err);
            showStatus(`LIFF初期化に失敗しました: ${err.message}`, 'error');
        }
    }

    function showStatus(message, type = 'success') {
        const statusDiv = document.getElementById('status');
        statusDiv.className = type;
        statusDiv.innerHTML = `<p>${message}</p>`;
    }

    document.getElementById('getBentoBtn').addEventListener('click', async () => {
        const button = document.getElementById('getBentoBtn');
        button.disabled = true;

        try {
            const profile = await liff.getProfile();
            const userId = profile.userId;
            console.log('UserID:', userId);

            const response = await fetch(`${serverUrl}/api/take-bento`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userId })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'エラーが発生しました');
            }

            const statusMessage = `
                <p>${data.message}</p>
                <p>現在の在庫: ${data.stock}個</p>
                ${data.logEntry ? `<p>取得日時: ${new Date(data.logEntry.takenAt).toLocaleString()}</p>` : ''}
            `;
            showStatus(statusMessage);
        } catch (error) {
            console.error('エラー:', error);
            showStatus(error.message || 'エラーが発生しました。もう一度お試しください。', 'error');
        } finally {
            button.disabled = false;
        }
    });

    initializeLiff();
</script>
